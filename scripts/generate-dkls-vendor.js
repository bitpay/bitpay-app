#!/usr/bin/env node

/**
 * generate-dkls-vendor.js
 *
 * DklsWorker.tsx loads the DKLS threshold-signature WASM library inside a
 * WebView. Instead of fetching it from a CDN at runtime, we bundle the
 * JS and WASM files locally as base64-encoded TypeScript constants.
 *
 * This script:
 *   1. Reads dkls-wasm-ll-web.js and dkls-wasm-ll-web_bg.wasm from
 *      node_modules/@silencelaboratories/dkls-wasm-ll-web (pinned to
 *      an exact version in package.json).
 *   2. Base64-encodes both files and writes them as TypeScript exports
 *      to src/dkls/vendor/.
 *   3. Embeds a SHA-256 checksum of each original file as a comment
 *      in the generated .ts file.
 *   4. Immediately verifies that the checksums written to disk match
 *      the source files. If they don't, the script exits with code 1,
 *      which causes the postinstall to fail â€” preventing the app from
 *      building with tampered or mismatched vendor files.
 *
 * It runs automatically via postinstall.sh on every `yarn install`,
 * so the vendor files are always in sync with the installed package.
 *
 * Usage:
 *   node scripts/generate-dkls-vendor.js           # generate + verify
 *   node scripts/generate-dkls-vendor.js --verify   # verify only (no write)
 */

const fs = require('fs');
const path = require('path');
const crypto = require('crypto');

const PKG_DIR = path.resolve(
  __dirname,
  '../node_modules/@silencelaboratories/dkls-wasm-ll-web',
);
const OUT_DIR = path.resolve(__dirname, '../src/dkls/vendor');

const JS_FILE = path.join(PKG_DIR, 'dkls-wasm-ll-web.js');
const WASM_FILE = path.join(PKG_DIR, 'dkls-wasm-ll-web_bg.wasm');

const JS_OUT = path.join(OUT_DIR, 'dkls-wasm-js-base64.ts');
const WASM_OUT = path.join(OUT_DIR, 'dkls-wasm-base64.ts');

function sha256(buffer) {
  return crypto.createHash('sha256').update(buffer).digest('hex');
}

function getPackageVersion() {
  const pkgJson = JSON.parse(
    fs.readFileSync(path.join(PKG_DIR, 'package.json'), 'utf8'),
  );
  return pkgJson.version;
}

function generate() {
  if (!fs.existsSync(JS_FILE) || !fs.existsSync(WASM_FILE)) {
    console.error(
      'Error: @silencelaboratories/dkls-wasm-ll-web not found in node_modules.',
    );
    console.error(
      'Run: yarn install (or yarn add --dev @silencelaboratories/dkls-wasm-ll-web)',
    );
    process.exit(1);
  }

  const version = getPackageVersion();

  // Read source files
  const jsRaw = fs.readFileSync(JS_FILE);
  const wasmRaw = fs.readFileSync(WASM_FILE);

  // Compute checksums of the original (non-encoded) files
  const jsHash = sha256(jsRaw);
  const wasmHash = sha256(wasmRaw);

  // Base64 encode
  const jsBase64 = jsRaw.toString('base64');
  const wasmBase64 = wasmRaw.toString('base64');

  // Ensure output directory exists
  if (!fs.existsSync(OUT_DIR)) {
    fs.mkdirSync(OUT_DIR, {recursive: true});
  }

  // Write JS base64 file
  const jsContent = [
    `// Auto-generated by scripts/generate-dkls-vendor.js`,
    `// @silencelaboratories/dkls-wasm-ll-web@${version}`,
    `// Source: dkls-wasm-ll-web.js`,
    `// SHA-256: ${jsHash}`,
    `// prettier-ignore`,
    `export const DKLS_JS_BASE64 =`,
    `  "${jsBase64}";`,
    ``,
  ].join('\n');

  // Write WASM base64 file
  const wasmContent = [
    `// Auto-generated by scripts/generate-dkls-vendor.js`,
    `// @silencelaboratories/dkls-wasm-ll-web@${version}`,
    `// Source: dkls-wasm-ll-web_bg.wasm`,
    `// SHA-256: ${wasmHash}`,
    `// prettier-ignore`,
    `export const DKLS_WASM_BASE64 =`,
    `  "${wasmBase64}";`,
    ``,
  ].join('\n');

  fs.writeFileSync(JS_OUT, jsContent);
  fs.writeFileSync(WASM_OUT, wasmContent);

  console.log(
    `[dkls-vendor] Generated files for @silencelaboratories/dkls-wasm-ll-web@${version}`,
  );
  console.log(`  JS  SHA-256: ${jsHash}`);
  console.log(`  WASM SHA-256: ${wasmHash}`);

  return {jsHash, wasmHash};
}

function verify(expectedHashes) {
  const version = getPackageVersion();

  // Read source files and compute expected checksums
  const jsRaw = fs.readFileSync(JS_FILE);
  const wasmRaw = fs.readFileSync(WASM_FILE);
  const expectedJsHash = expectedHashes
    ? expectedHashes.jsHash
    : sha256(jsRaw);
  const expectedWasmHash = expectedHashes
    ? expectedHashes.wasmHash
    : sha256(wasmRaw);

  let ok = true;

  for (const [filePath, expectedHash, label] of [
    [JS_OUT, expectedJsHash, 'JS'],
    [WASM_OUT, expectedWasmHash, 'WASM'],
  ]) {
    if (!fs.existsSync(filePath)) {
      console.error(`  MISSING: ${filePath}`);
      ok = false;
      continue;
    }

    const content = fs.readFileSync(filePath, 'utf8');
    const match = content.match(/^\/\/ SHA-256: ([a-f0-9]{64})$/m);

    if (!match) {
      console.error(`  NO CHECKSUM found in ${filePath}`);
      ok = false;
      continue;
    }

    const embeddedHash = match[1];
    if (embeddedHash !== expectedHash) {
      console.error(
        `  MISMATCH (${label}): embedded=${embeddedHash}, expected=${expectedHash}`,
      );
      ok = false;
      continue;
    }

    const b64Match = content.match(/export const \w+ =\n  "([A-Za-z0-9+/=]+)";/);
    if (!b64Match) {
      console.error(`  NO BASE64 CONTENT found in ${filePath}`);
      ok = false;
      continue;
    }
    const decodedHash = sha256(Buffer.from(b64Match[1], 'base64'));
    if (decodedHash !== expectedHash) {
      console.error(
        `  BASE64 CONTENT MISMATCH (${label}): decoded hash=${decodedHash}, expected=${expectedHash}`,
      );
      ok = false;
    } else {
      console.log(`  OK (${label}): SHA-256 ${embeddedHash}`);
    }
  }

  if (!ok) {
    console.error(
      '\n[dkls-vendor] Verification FAILED. Vendor files do not match the installed package.',
    );
    process.exit(1);
  }

  console.log(
    `[dkls-vendor] Verified: files match @silencelaboratories/dkls-wasm-ll-web@${version}`,
  );
}

// Main
const args = process.argv.slice(2);
if (args.includes('--verify')) {
  verify();
} else {
  const hashes = generate();
  verify(hashes);
}
